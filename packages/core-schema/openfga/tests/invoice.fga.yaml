name: Tests for invoice module

model_file: ../fga.mod
tuple_files:
  - ../tuples/core-tuples.yaml
  - ../tuples/invoice-tuples.yaml

tests:
  # =============================================================================
  # FOLDER-LEVEL PERMISSIONS
  # =============================================================================
  - name: Invoices folder has correct team assignments
    check:
      # Finance team is the owner team
      - user: user:finance_head
        object: folder:invoices
        assertions:
          owner: true
          viewer: true
      - user: user:finance_manager
        object: folder:invoices
        assertions:
          owner: true
          viewer: true
      - user: user:finance_member1
        object: folder:invoices
        assertions:
          owner: true
          viewer: true

  # =============================================================================
  # FINANCE TEAM PERMISSIONS (INVOICE MANAGERS VIA FOLDER)
  # =============================================================================
  - name: Finance team members have full invoice permissions via folder ownership
    check:
      # Finance team head has all permissions
      - user: user:finance_head
        object: invoice:inv001
        assertions:
          can_view_invoice: true
          can_create_invoice: true
          can_edit_invoice: true
          can_delete_invoice: true

      - user: user:finance_head
        object: invoice:inv002
        assertions:
          can_view_invoice: true
          can_create_invoice: true
          can_edit_invoice: true
          can_delete_invoice: true

      # Finance team manager has all permissions
      - user: user:finance_manager
        object: invoice:inv002
        assertions:
          can_view_invoice: true
          can_create_invoice: true
          can_edit_invoice: true
          can_delete_invoice: true

      # Finance team members have all permissions
      - user: user:finance_member1
        object: invoice:inv004
        assertions:
          can_view_invoice: true
          can_create_invoice: true
          can_edit_invoice: true
          can_delete_invoice: true

  # =============================================================================
  # OTHER TEAMS HAVE NO INVOICE ACCESS
  # =============================================================================
  - name: Sales team members have no invoice permissions
    check:
      # Sales team head
      - user: user:sales_head
        object: invoice:inv001
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false
      - user: user:sales_head
        object: invoice:inv002
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

      # Sales team managers
      - user: user:sales_manager1
        object: invoice:inv003
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false
      - user: user:sales_manager2
        object: invoice:inv004
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false
      # Sales team members
      - user: user:sales_member1
        object: invoice:inv005
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

      - user: user:sales_member2
        object: invoice:inv006
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

  # =============================================================================
  # PRODUCT TEAM PERMISSIONS (NO INVOICE ACCESS)
  # =============================================================================
  - name: Product team members have no invoice permissions
    check:
      # Product team head
      - user: user:product_head
        object: invoice:inv001
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

      - user: user:product_head
        object: invoice:inv002
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

      # Product team managers
      - user: user:product_manager1
        object: invoice:inv003
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

      - user: user:product_manager2
        object: invoice:inv004
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

      # Product team members
      - user: user:product_member1
        object: invoice:inv005
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

      - user: user:product_member2
        object: invoice:inv006
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

      - user: user:product_member3
        object: invoice:inv007
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

  # =============================================================================
  # PURCHASE TEAM PERMISSIONS (NO INVOICE ACCESS)
  # =============================================================================
  - name: Purchase team members have no invoice permissions
    check:
      # Purchase team head
      - user: user:purchase_head
        object: invoice:inv001
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

      # Purchase team managers
      - user: user:purchase_manager1
        object: invoice:inv002
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

      # Purchase team members
      - user: user:purchase_member1
        object: invoice:inv003
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

  # =============================================================================
  # IS_COMPLETED FLAG TESTS (INVOICE EDITING RESTRICTIONS)
  # =============================================================================
  - name: Completed invoices cannot be edited or approved but can still be deleted
    tuples:
      # Mark invoice inv001 as completed
      - user: invoice:inv001
        relation: is_completed
        object: invoice:inv001
      # Mark invoice inv002 as completed
      - user: invoice:inv002
        relation: is_completed
        object: invoice:inv002
    check:
      # Finance team can still view completed invoices
      - user: user:finance_head
        object: invoice:inv001
        assertions:
          can_view_invoice: true
          can_create_invoice: true # This is not restricted by completion
      - user: user:finance_manager
        object: invoice:inv002
        assertions:
          can_view_invoice: true
          can_create_invoice: true

      # But cannot edit or approve completed invoices
      - user: user:finance_head
        object: invoice:inv001
        assertions:
          can_edit_invoice: false # Blocked by is_completed

      - user: user:finance_manager
        object: invoice:inv002
        assertions:
          can_edit_invoice: false

      # However, can still delete completed invoices (special requirement)
      - user: user:finance_head
        object: invoice:inv001
        assertions:
          can_delete_invoice: true # NOT blocked by is_completed
      - user: user:finance_manager
        object: invoice:inv002
        assertions:
          can_delete_invoice: true

  - name: Non-completed invoices can still be edited and approved by authorized teams
    check:
      # inv004 is NOT marked as completed (no is_completed tuples)
      # This tests the normal flow where invoices can be edited and approved
      # Finance team can edit non-completed invoices
      - user: user:finance_head
        object: invoice:inv004
        assertions:
          can_view_invoice: true
          can_create_invoice: true
          can_edit_invoice: true # Not blocked by is_completed
          can_delete_invoice: true

      - user: user:finance_member1
        object: invoice:inv004
        assertions:
          can_view_invoice: true
          can_create_invoice: true
          can_edit_invoice: true
          can_delete_invoice: true

  # =============================================================================
  # FOLDER LINKAGE VALIDATION
  # =============================================================================
  - name: All invoices are properly linked to their folder
    check:
      # Verify that invoices derive permissions from their folder
      - user: user:finance_head
        object: invoice:inv001
        assertions:
          can_edit_invoice: true # Should work via folder ownership
      - user: user:finance_member1
        object: invoice:inv002
        assertions:
          can_edit_invoice: true # Should work via folder ownership
      - user: user:sales_member1
        object: invoice:inv003
        assertions:
          can_view_invoice: false
          can_edit_invoice: false
      - user: user:product_member1
        object: invoice:inv004
        assertions:
          can_view_invoice: false
          can_edit_invoice: false

  # =============================================================================
  # TEAM HIERARCHY VALIDATION
  # =============================================================================
  - name: Finance team hierarchy works correctly for invoices
    check:
      # Finance team head has all team permissions
      - user: user:finance_head
        object: team:finance
        assertions:
          head: true
          manager: true
          member: true
      # Finance team manager has manager and member permissions
      - user: user:finance_manager
        object: team:finance
        assertions:
          head: false
          manager: true
          member: true
      # Finance team members have only member permissions
      - user: user:finance_member1
        object: team:finance
        assertions:
          head: false
          manager: false
          member: true

  - name: Sales team hierarchy works correctly for invoices
    check:
      # Sales team head has all team permissions
      - user: user:sales_head
        object: team:sales
        assertions:
          head: true
          manager: true
          member: true
      # Sales team managers have manager and member permissions
      - user: user:sales_manager1
        object: team:sales
        assertions:
          head: false
          manager: true
          member: true
      # Sales team members have only member permissions
      - user: user:sales_member1
        object: team:sales
        assertions:
          head: false
          manager: false
          member: true

  - name: Product team hierarchy works correctly for invoices
    check:
      # Product team head has all team permissions
      - user: user:product_head
        object: team:product
        assertions:
          head: true
          manager: true
          member: true
      # Product team managers have manager and member permissions
      - user: user:product_manager1
        object: team:product
        assertions:
          head: false
          manager: true
          member: true
      # Product team members have only member permissions
      - user: user:product_member1
        object: team:product
        assertions:
          head: false
          manager: false
          member: true

  # =============================================================================
  # ORGANIZATION MEMBERSHIP VALIDATION
  # =============================================================================
  - name: All team members belong to the organization
    check:
      # Finance team members are organization members
      - user: user:finance_head
        object: organization:acme-corp
        assertions:
          member: true
      - user: user:finance_manager
        object: organization:acme-corp
        assertions:
          member: true
      - user: user:finance_member1
        object: organization:acme-corp
        assertions:
          member: true
      # Sales team members are organization members
      - user: user:sales_head
        object: organization:acme-corp
        assertions:
          member: true
      - user: user:sales_manager1
        object: organization:acme-corp
        assertions:
          member: true
      - user: user:sales_member1
        object: organization:acme-corp
        assertions:
          member: true
      # Product team members are organization members
      - user: user:product_head
        object: organization:acme-corp
        assertions:
          member: true
      - user: user:product_manager1
        object: organization:acme-corp
        assertions:
          member: true
      - user: user:product_member1
        object: organization:acme-corp
        assertions:
          member: true

  # =============================================================================
  # PERMISSION HIERARCHY VALIDATION
  # =============================================================================
  - name: Edit permissions imply view permissions
    check:
      # Finance team members who can edit should also be able to view
      - user: user:finance_head
        object: invoice:inv001
        assertions:
          can_edit_invoice: true
          can_view_invoice: true # should be true due to "or can_edit_invoice"
      - user: user:finance_member1
        object: invoice:inv002
        assertions:
          can_edit_invoice: true
          can_view_invoice: true

  - name: Delete permissions imply edit permissions
    check:
      # Finance team members who can delete should also be able to edit
      - user: user:finance_head
        object: invoice:inv001
        assertions:
          can_delete_invoice: true
          can_edit_invoice: true # Both should be true for finance team
      - user: user:finance_member1
        object: invoice:inv002
        assertions:
          can_delete_invoice: true
          can_edit_invoice: true

  # =============================================================================
  # CROSS-INVOICE PERMISSIONS
  # =============================================================================
  - name: Finance team permissions work across all invoices
    check:
      # Finance head should have full permissions on all invoices
      - user: user:finance_head
        object: invoice:inv001
        assertions:
          can_view_invoice: true
          can_edit_invoice: true
      # Finance members should have permissions on all invoices
      - user: user:finance_member1
        object: invoice:inv001
        assertions:
          can_view_invoice: true
          can_edit_invoice: true

  # =============================================================================
  # NEGATIVE TESTS
  # =============================================================================
  - name: Users without team relationships have no invoice permissions
    check:
      - user: user:random_user
        object: invoice:inv001
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

  - name: Organization members without team membership have no invoice access
    check:
      # Direct organization members (not in any team) should have no invoice access
      - user: user:org_member1
        object: invoice:inv001
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

  - name: Organization admin has organization permissions but not invoice
    check:
      # Organization admin should have org access but not automatic invoice access
      - user: user:org_admin
        object: organization:acme-corp
        assertions:
          admin: true
          member: true
      # But no automatic invoice permissions
      - user: user:org_admin
        object: invoice:inv001
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

  - name: Teams without explicit access cannot view invoices
    check:
      # Purchase team should not have any invoice access
      - user: user:purchase_head
        object: invoice:inv001
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

      - user: user:purchase_member1
        object: invoice:inv007
        assertions:
          can_view_invoice: false
          can_create_invoice: false
          can_edit_invoice: false
          can_delete_invoice: false

  # =============================================================================
  # FOLDER PERMISSIONS VALIDATION
  # =============================================================================
  - name: Invoices folder correctly manages team-based access control
    check:
      # Finance team owns the folder and gets full access
      - user: user:finance_head
        object: folder:invoices
        assertions:
          owner: true
          viewer: true
      - user: user:finance_member1
        object: folder:invoices
        assertions:
          owner: true
          viewer: true
      # Other teams have no access to the folder
      - user: user:sales_head
        object: folder:invoices
        assertions:
          owner: false
          viewer: false
      - user: user:product_head
        object: folder:invoices
        assertions:
          owner: false
          viewer: false
      - user: user:purchase_head
        object: folder:invoices
        assertions:
          owner: false
          viewer: false
