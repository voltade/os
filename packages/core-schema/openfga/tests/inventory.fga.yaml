name: Tests for inventory module

model_file: ../fga.mod
tuple_files:
  - ../tuples/core-tuples.yaml
  - ../tuples/inventory-tuples.yaml

tests:
  # =============================================================================
  # FOLDER-LEVEL PERMISSIONS
  # =============================================================================
  - name: Inventory folder has correct team assignments
    check:
      # Product team is the owner team (only team with access)
      - user: user:product_head
        object: folder:inventory
        assertions:
          owner: true
          viewer: true
      - user: user:product_manager1
        object: folder:inventory
        assertions:
          owner: true
          viewer: true
      - user: user:product_member1
        object: folder:inventory
        assertions:
          owner: true
          viewer: true

      # Other teams have no folder access
      - user: user:sales_head
        object: folder:inventory
        assertions:
          owner: false
          viewer: false
      - user: user:finance_head
        object: folder:inventory
        assertions:
          owner: false
          viewer: false
      - user: user:purchase_head
        object: folder:inventory
        assertions:
          owner: false
          viewer: false

  # =============================================================================
  # PRODUCT TEAM PERMISSIONS (INVENTORY MANAGERS VIA FOLDER)
  # =============================================================================
  - name: Product team members have full inventory permissions via folder ownership
    check:
      # Product team head has all permissions
      - user: user:product_head
        object: inventory:p001
        assertions:
          can_view_products: true
          can_create_products: true
          can_edit_products: true
          can_delete_products: true
          can_view_stock: true
          can_edit_stock: true
      - user: user:product_head
        object: inventory:p002
        assertions:
          can_view_products: true
          can_create_products: true
          can_edit_products: true
          can_delete_products: true
          can_view_stock: true
          can_edit_stock: true
      # Product team managers have all permissions
      - user: user:product_manager1
        object: inventory:p003
        assertions:
          can_view_products: true
          can_create_products: true
          can_edit_products: true
          can_delete_products: true
          can_view_stock: true
          can_edit_stock: true
      - user: user:product_manager2
        object: inventory:p004
        assertions:
          can_view_products: true
          can_create_products: true
          can_edit_products: true
          can_delete_products: true
          can_view_stock: true
          can_edit_stock: true
      # Product team members have all permissions
      - user: user:product_member1
        object: inventory:p005
        assertions:
          can_view_products: true
          can_create_products: true
          can_edit_products: true
          can_delete_products: true
          can_view_stock: true
          can_edit_stock: true
      - user: user:product_member2
        object: inventory:p001
        assertions:
          can_view_products: true
          can_create_products: true
          can_edit_products: true
          can_delete_products: true
          can_view_stock: true
          can_edit_stock: true

  # =============================================================================
  # OTHER TEAMS HAVE NO ACCESS TO INVENTORY
  # =============================================================================
  - name: Sales team members have no inventory permissions
    check:
      # Sales team head
      - user: user:sales_head
        object: inventory:p001
        assertions:
          can_view_products: false
          can_create_products: false
          can_edit_products: false
          can_delete_products: false
          can_view_stock: false
          can_edit_stock: false
      # Sales team managers
      - user: user:sales_manager1
        object: inventory:p002
        assertions:
          can_view_products: false
          can_create_products: false
          can_edit_products: false
          can_delete_products: false
          can_view_stock: false
          can_edit_stock: false
      # Sales team members
      - user: user:sales_member1
        object: inventory:p003
        assertions:
          can_view_products: false
          can_create_products: false
          can_edit_products: false
          can_delete_products: false
          can_view_stock: false
          can_edit_stock: false

  - name: Finance team members have no inventory permissions
    check:
      # Finance team head
      - user: user:finance_head
        object: inventory:p001
        assertions:
          can_view_products: false
          can_create_products: false
          can_edit_products: false
          can_delete_products: false
          can_view_stock: false
          can_edit_stock: false
      # Finance team manager
      - user: user:finance_manager
        object: inventory:p002
        assertions:
          can_view_products: false
          can_create_products: false
          can_edit_products: false
          can_delete_products: false
          can_view_stock: false
          can_edit_stock: false
      # Finance team members
      - user: user:finance_member1
        object: inventory:p003
        assertions:
          can_view_products: false
          can_create_products: false
          can_edit_products: false
          can_delete_products: false
          can_view_stock: false
          can_edit_stock: false

  - name: Purchase team members have no inventory permissions
    check:
      # Purchase team head
      - user: user:purchase_head
        object: inventory:p001
        assertions:
          can_view_products: false
          can_create_products: false
          can_edit_products: false
          can_delete_products: false
          can_view_stock: false
          can_edit_stock: false
      # Purchase team managers
      - user: user:purchase_manager1
        object: inventory:p002
        assertions:
          can_view_products: false
          can_create_products: false
          can_edit_products: false
          can_delete_products: false
          can_view_stock: false
          can_edit_stock: false
      # Purchase team members
      - user: user:purchase_member1
        object: inventory:p003
        assertions:
          can_view_products: false
          can_create_products: false
          can_edit_products: false
          can_delete_products: false
          can_view_stock: false
          can_edit_stock: false

  # =============================================================================
  # IS_COMPLETED FLAG TESTS (INVENTORY EDITING RESTRICTIONS)
  # =============================================================================
  - name: Completed inventory cannot be edited but can still be viewed and deleted
    tuples:
      # Mark inventory as completed
      - user: inventory:p001
        relation: is_completed
        object: inventory:p001
    check:
      # Product team can still view completed inventory
      - user: user:product_head
        object: inventory:p001
        assertions:
          can_view_products: true
          can_create_products: true # This is not restricted by completion
          can_view_stock: true

      # But cannot edit completed inventory (products or stock)
      - user: user:product_head
        object: inventory:p001
        assertions:
          can_edit_products: false # Blocked by is_completed
          can_edit_stock: false # Blocked by is_completed

      # However, can still delete completed inventory (follows same pattern as invoices)
      - user: user:product_head
        object: inventory:p001
        assertions:
          can_delete_products: true # NOT blocked by is_completed

  - name: Non-completed inventory can be edited by authorized teams
    check:
      # Test without is_completed flag - normal operations should work
      # Product team can edit non-completed inventory
      - user: user:product_head
        object: inventory:p002
        assertions:
          can_view_products: true
          can_create_products: true
          can_edit_products: true # Not blocked by is_completed
          can_delete_products: true
          can_view_stock: true
          can_edit_stock: true # Not blocked by is_completed

      - user: user:product_member1
        object: inventory:p003
        assertions:
          can_view_products: true
          can_create_products: true
          can_edit_products: true # Not blocked by is_completed
          can_delete_products: true
          can_view_stock: true
          can_edit_stock: true # Not blocked by is_completed

  # =============================================================================
  # FOLDER LINKAGE VALIDATION
  # =============================================================================
  - name: All inventories are properly linked to their folder
    check:
      # Verify that inventory derives permissions from its folder
      - user: user:product_head
        object: inventory:p001
        assertions:
          can_edit_products: true # Should work via folder ownership
          can_edit_stock: true # Should work via folder ownership
      - user: user:product_member1
        object: inventory:p002
        assertions:
          can_edit_products: true # Should work via folder ownership
          can_edit_stock: true # Should work via folder ownership

  # =============================================================================
  # TEAM HIERARCHY VALIDATION
  # =============================================================================
  - name: Product team hierarchy works correctly
    check:
      # Product team head has all team permissions
      - user: user:product_head
        object: team:product
        assertions:
          head: true
          manager: true
          member: true
      # Product team managers have manager and member permissions
      - user: user:product_manager1
        object: team:product
        assertions:
          head: false
          manager: true
          member: true
      # Product team members have only member permissions
      - user: user:product_member1
        object: team:product
        assertions:
          head: false
          manager: false
          member: true

  - name: Sales team hierarchy works correctly
    check:
      # Sales team head has all team permissions
      - user: user:sales_head
        object: team:sales
        assertions:
          head: true
          manager: true
          member: true
      # Sales team managers have manager and member permissions
      - user: user:sales_manager1
        object: team:sales
        assertions:
          head: false
          manager: true
          member: true
      # Sales team members have only member permissions
      - user: user:sales_member1
        object: team:sales
        assertions:
          head: false
          manager: false
          member: true

  - name: Finance team hierarchy works correctly
    check:
      # Finance team head has all team permissions
      - user: user:finance_head
        object: team:finance
        assertions:
          head: true
          manager: true
          member: true
      # Finance team manager has manager and member permissions
      - user: user:finance_manager
        object: team:finance
        assertions:
          head: false
          manager: true
          member: true
      # Finance team members have only member permissions
      - user: user:finance_member1
        object: team:finance
        assertions:
          head: false
          manager: false
          member: true

  - name: Purchase team hierarchy works correctly
    check:
      # Purchase team head has all team permissions
      - user: user:purchase_head
        object: team:purchase
        assertions:
          head: true
          manager: true
          member: true
      # Purchase team managers have manager and member permissions
      - user: user:purchase_manager1
        object: team:purchase
        assertions:
          head: false
          manager: true
          member: true
      - user: user:purchase_manager2
        object: team:purchase
        assertions:
          head: false
          manager: true
          member: true
      # Purchase team members have only member permissions
      - user: user:purchase_member1
        object: team:purchase
        assertions:
          head: false
          manager: false
          member: true

  # =============================================================================
  # PERMISSION HIERARCHY VALIDATION
  # =============================================================================
  - name: Edit permissions imply view and create permissions
    check:
      # Product team members who can edit should also be able to view and create
      - user: user:product_head
        object: inventory:p001
        assertions:
          can_edit_products: true
          can_view_products: true # should be true due to "or can_edit_products"
          can_create_products: true # should be true due to "or can_edit_products"
      - user: user:product_member1
        object: inventory:p002
        assertions:
          can_edit_products: true
          can_view_products: true
          can_create_products: true

  # =============================================================================
  # NEGATIVE TESTS
  # =============================================================================
  - name: Users without team relationships have no inventory permissions
    check:
      - user: user:random_user
        object: inventory:p001
        assertions:
          can_view_products: false
          can_create_products: false
          can_edit_products: false
          can_delete_products: false
          can_view_stock: false
          can_edit_stock: false

  - name: Organization members without team membership have limited access
    check:
      # Direct organization members (not in any team) should have no inventory access
      - user: user:org_member1
        object: inventory:p001
        assertions:
          can_view_products: false
          can_create_products: false
          can_edit_products: false
          can_delete_products: false
          can_view_stock: false
          can_edit_stock: false

  - name: Organization admin has organization permissions but not inventory
    check:
      # Organization admin should have org access but not automatic inventory access
      - user: user:org_admin
        object: organization:acme-corp
        assertions:
          admin: true
          member: true
      # But no automatic inventory permissions
      - user: user:org_admin
        object: inventory:p001
        assertions:
          can_view_products: false
          can_create_products: false
          can_edit_products: false
          can_delete_products: false
          can_view_stock: false
          can_edit_stock: false
