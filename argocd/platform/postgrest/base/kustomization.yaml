apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

helmCharts:
  - repo: oci://registry.127.0.0.1.nip.io
    name: postgrest
    releaseName: postgrest
    namespace: platform
    valuesInline:
      enabled: true
      replicaCount: 1
      image:
        repository: postgrest/postgrest
        pullPolicy: IfNotPresent
      service:
        type: ClusterIP
        port: 3000
      resources:
        requests:
          memory: 64Mi
          cpu: 25m
        limits:
          memory: 128Mi
          cpu: 50m
      environment:
        PGRST_DB_URI: $(DB_DRIVER)://$(DB_USER):$(DB_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(DB_NAME)?sslmode=$(DB_SSL)
        DB_DRIVER: postgres
        DB_HOST: cnpg-cluster-rw
        DB_PORT: 5432
        DB_USER:
          valueFrom:
            secretKeyRef:
              name: cnpg-platform-admin
              key: username
        DB_PASSWORD:
          valueFrom:
            secretKeyRef:
              name: cnpg-platform-admin
              key: password
        DB_NAME: platform
        DB_SSL: disable
        PGRST_APP_SETTINGS_JWT_EXP: 3600
        PGRST_DB_ANON_ROLE: anon
        PGRST_DB_SCHEMAS: public
        PGRST_OPENAPI_MODE: disabled
        # https://docs.postgrest.org/en/v13/references/configuration.html#jwt-secret
        # https://docs.postgrest.org/en/v13/references/auth.html#asymmetric-keys
        # argocd/platform/kratos/base/jwt-jwks-public.json
        PGRST_JWT_SECRET: ewogICJrdHkiOiAiUlNBIiwKICAiZSI6ICJBUUFCIiwKICAidXNlIjogInNpZyIsCiAgImtpZCI6ICJ2b2x0YWRlLW9zIiwKICAiYWxnIjogIlJTMjU2IiwKICAibiI6ICJpV1U5NGpVbUJnVXJUMGcyR2pOSGp6b3dUdGE1WkE1V2p1eWdjR1pSSTRKUG1STUtxNTM2TUlvb3ByQXlvNmp5SnZvS3RVOVRvRFVDam9NVWcxaEw4WGJCNWZyQlpXUTl0LWpuaExpRHlTTFpUV1A0Z0ptVkVXRUVEdnZsQy1zX0J5bnVLazZ6X3Jfb1NHYjdfRmxMWUlNcGR0TVQwLVl4cElaT3RKM2d1clNvVzFIajk1SWI5eXU5Q3dBLUNkRlozdDhiSWNDY19lNEJEZ1NTaTF5SFUzb05OMDZqajJuN1FxVTdoVXl1TW9IdllzLXAxR1FTY1ZQUVB6SDFGUndPNFV6Z3lSTUgxWGdKWlBMOERvVHdYcXpVRlQwaUo0NHFFWDJ4RW1hNW5BVzN2MmxYVHVIUDJDc19DRVFST2lSaGM1RHladmpDR3RjNXhQM1VkOWdPaVEiCn0K
        PGRST_JWT_SECRET_IS_BASE64: "true"
        PGRST_SERVER_CORS_ALLOWED_ORIGINS: http://127.0.0.1.nip.io
